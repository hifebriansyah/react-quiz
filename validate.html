<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="theme-color" content="#e84118" />
    <link rel="manifest" href="%PUBLIC_URL%/manifest.json" />
    <title>ScrumTeam.id</title>

    <!-- Styling -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">

    <!-- Chrome App -->
    <meta name="mobile-web-app-capable" content="yes" />

    <!-- Safari App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="hifebriansyah">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
</head>
<body>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
	<script>
		fetch("https://gist.githubusercontent.com/hifebriansyah/54154efe6e98d268c923fc740339f8c1/raw")
			.then(response => {
				return response.json();
			})
			.then(result => {
				const urlParams = new URLSearchParams(window.location.search);
				const selections = JSON.parse(CryptoJS.AES.decrypt(decodeURIComponent(urlParams.get('selections')), 'selections').toString(CryptoJS.enc.Utf8));
				const questions = JSON.parse(CryptoJS.AES.decrypt(decodeURIComponent(urlParams.get('questions')), 'questions').toString(CryptoJS.enc.Utf8));
				const section = CryptoJS.AES.decrypt(decodeURIComponent(urlParams.get('section')), 'section').toString(CryptoJS.enc.Utf8);

				let response = {
					score : 0,
					questions : [],
					correct: 0,
					incorrect: 0,
				};

				Object.keys(selections).map(function(id, index) {
					question = searchById(questions, id);
					selections[id] = selections[id].sort().join();
					result[id].answers = result[id].answers.sort().join();


					response.questions[index] = {
						selections : selections[id].split(','),
						answers : result[id].answers.split(','),
						feedback : result[id].feedback,
						correct : false,
						content : question.content,
						options : question.options,
					}
					
				    if(selections[id] == result[id].answers) {
				    	response.correct++;
				    	response.questions[index].correct = true;
				    } else {
				    	response.incorrect++;
				    }

				    response.questions[index].options.map(function(option){
						option.selection = response.questions[index].selections.indexOf(option.id+"") >= 0;
				    	option.answer = response.questions[index].answers.indexOf(option.id+"") >= 0;
				    });

				    response.score = response.correct / (response.correct + response.incorrect) * 100;
				});

				response.section = section;

				window.location.replace("/result?result=" + encodeURIComponent(CryptoJS.AES.encrypt(JSON.stringify(response), 'result')));
			});

			function searchById(array, id) {
				for (var i=0; i < array.length; i++) {
			        if (array[i].id+"" === id) {
			        	return array[i];
			        }
			    }
			}
	</script>
</body>
</html>